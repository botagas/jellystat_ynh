#!/bin/bash

#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# STOP SYSTEMD SERVICE
#=================================================
ynh_script_progression "Stopping $app's systemd service..."

ynh_systemctl --service="$app" --action="stop"

#=================================================
# ENSURE DOWNWARD COMPATIBILITY
#=================================================
ynh_script_progression "Ensuring downward compatibility..."

# Example: If a setting was not defined in earlier versions, set it up
# Uncomment if necessary
# ynh_app_setting_set_default --key=some_setting --value="default_value"

#=================================================
# UPGRADE SOURCE FILES
#=================================================
ynh_script_progression "Upgrading source files..."

# Replace the installation directory while keeping the .env file intact
ynh_setup_source --dest_dir="$install_dir" --full_replace --keep=".env"

# Reapply ownership and permissions
chown -R "$app:www-data" "$install_dir"

#=================================================
# INSTALL DEPENDENCIES
#=================================================
ynh_script_progression "Installing dependencies..."

ynh_nodejs_install
npm install --prefix "$install_dir"

#=================================================
# REAPPLY SYSTEM CONFIGURATIONS
#=================================================
ynh_script_progression "Reapplying system configurations..."

# Reconfigure NGINX
ynh_add_nginx_config

# Reconfigure systemd
ynh_add_systemd

# Reconfigure logrotate
ynh_add_logrotate

# Ensure log directory exists
mkdir -p "/var/log/$app"
chown "$app:$app" "/var/log/$app"

#=================================================
# RESTART SYSTEMD SERVICE
#=================================================
ynh_script_progression "Restarting $app's systemd service..."

ynh_systemctl --service="$app" --action="start"

# Reload NGINX
ynh_systemctl --service=nginx --action=reload

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Upgrade of $app completed"
